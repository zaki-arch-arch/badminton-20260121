<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="manifest" href="./manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js').then(function(registration) {
        console.log('ServiceWorkerã®ç™»éŒ²æˆåŠŸã‚„ï¼ã‚¹ã‚³ãƒ¼ãƒ—: ', registration.scope);
      }, function(err) {
        console.log('ServiceWorkerã®ç™»éŒ²å¤±æ•—ã‚„â€¦: ', err);
      });
    });
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Matcher Ultimate Balance V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { color: #4f46e5; border-bottom: 2px solid #4f46e5; font-weight: bold; }
        .hidden { display: none !important; }
        body { -webkit-overflow-scrolling: touch; }
        .modal-bg { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
        .text-male { color: #1d4ed8; }
        .text-female { color: #db2777; }

        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; color: black; font-family: serif; }
            .no-print, nav, header, #tab-players, #tab-stats, #control-area { display: none !important; }
            main { max-width: 100% !important; padding: 0 !important; }
            #tab-matches { display: block !important; }
            #match-display-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .match-card { break-inside: avoid; border: 2px solid #000; box-shadow: none !important; background: white !important; color: black !important; }
            .court-label-area { display: none !important; }
            .print-court-label { display: block !important; background: #000 !important; color: #fff !important; font-size: 12px; padding: 3px 10px; margin-bottom: 10px; border-radius: 4px; display: inline-block; }
            .team-box { background: #fff !important; border: 1px solid #ccc !important; }
            .vs-label { color: #000 !important; }
            .text-male { color: #1d4ed8 !important; -webkit-print-color-adjust: exact; }
            .text-female { color: #db2777 !important; -webkit-print-color-adjust: exact; }
            #print-header { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; }
        }
        #print-header { display: none; }
        .print-court-label { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-24 font-sans">

    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-40 no-print">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-lg font-bold">ğŸ¸ Matcher Pro</h1>
            <div id="header-count" class="text-[10px] bg-white/20 px-2 py-1 rounded">å‚åŠ : 0å</div>
        </div>
    </header>

    <div id="print-header">
        <h1 class="text-2xl font-bold">ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³å¯¾æˆ¦è¡¨</h1>
        <p id="print-round-info" class="text-lg">ç¬¬ X è©¦åˆ</p>
    </div>

    <main class="max-w-md mx-auto p-4">
        
        <section id="tab-matches" class="space-y-4">
            <div id="control-area" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</p>
                <div class="space-y-2">
                    <button onclick="generateMatches('level')" class="w-full flex items-center justify-between px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg font-bold border border-indigo-200 transition-all text-sm group shadow-sm active:scale-95">
                        <span class="flex items-center gap-2 text-lg">ğŸ’ª <span class="text-sm">ãƒ¬ãƒ™ãƒ«åˆ¥</span></span>
                        <span class="text-[10px] font-normal text-gray-500">åŒã˜ãƒ©ãƒ³ã‚¯åŒå£«ã§å¯¾æˆ¦</span>
                    </button>
                    
                    <button onclick="generateMatches('balanced')" class="w-full flex items-center justify-between px-4 py-3 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg font-bold border border-green-200 transition-all text-sm group shadow-sm active:scale-95">
                        <span class="flex items-center gap-2 text-lg">âš–ï¸ <span class="text-sm">ãƒãƒ©ãƒ³ã‚¹</span></span>
                        <span class="text-[10px] font-normal text-gray-500">æˆ¦åŠ›ãŒæ‹®æŠ—ã™ã‚‹ã‚ˆã†ã«èª¿æ•´</span>
                    </button>
                    
                    <button onclick="generateMatches('random')" class="w-full flex items-center justify-between px-4 py-3 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg font-bold border border-orange-200 transition-all text-sm group shadow-sm active:scale-95">
                        <span class="flex items-center gap-2 text-lg">ğŸ² <span class="text-sm">ãƒ©ãƒ³ãƒ€ãƒ </span></span>
                        <span class="text-[10px] font-normal text-gray-500">ãƒ¬ãƒ™ãƒ«ç„¡è¦–ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«</span>
                    </button>
                </div>
            </div>

            <button id="btn-print" onclick="openPrintWindow()" class="no-print hidden w-full py-3 bg-gray-700 text-white rounded-lg font-bold text-sm shadow-md flex items-center justify-center gap-2 active:bg-gray-800 transition-all">
                ğŸ–¨ï¸ åˆ¥çª“ã§å°åˆ·ç”»é¢ã‚’é–‹ã (A4/PDF)
            </button>
            
            <div id="match-display-area" class="space-y-4"></div>

            <div id="rest-section" class="hidden mt-8 no-print">
                <h3 class="text-[10px] font-bold text-gray-400 mb-2 uppercase flex items-center gap-2">
                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>ä»Šå›ã®ãŠä¼‘ã¿
                </h3>
                <div id="rest-list-area" class="flex flex-wrap gap-2"></div>
            </div>
        </section>

        <section id="tab-players" class="hidden space-y-4 no-print">
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <input id="p-name" class="w-full border rounded px-3 py-2 mb-2 text-sm" placeholder="åå‰">
                <div class="flex gap-2">
                    <select id="p-gender" class="border rounded px-2 text-sm bg-white"><option value="M">ç”·æ€§</option><option value="F">å¥³æ€§</option></select>
                    <select id="p-rank" class="flex-1 border rounded px-2 text-sm bg-white"><option value="1">ãƒ©ãƒ³ã‚¯1:å¼·</option><option value="2" selected>ãƒ©ãƒ³ã‚¯2:ä¸­</option><option value="3">ãƒ©ãƒ³ã‚¯3:å¼±</option></select>
                    <button onclick="addPlayer()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">è¿½åŠ </button>
                </div>
            </div>
            
            <!-- â˜… ä¸¦ã³æ›¿ãˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="flex justify-between items-center px-1 text-[10px]">
                <span class="font-bold text-gray-400 uppercase">ä¸¦ã³æ›¿ãˆ</span>
                <div class="flex gap-1">
                    <button onclick="setPlayerSort('default')" id="sort-default" class="px-2 py-1 rounded border transition-colors bg-indigo-100 text-indigo-700 font-bold border-indigo-300">ç™»éŒ²é †</button>
                    <button onclick="setPlayerSort('gender')" id="sort-gender" class="px-2 py-1 rounded border transition-colors bg-white text-gray-500 border-gray-200">ç”·å¥³åˆ¥</button>
                    <button onclick="setPlayerSort('rank')" id="sort-rank" class="px-2 py-1 rounded border transition-colors bg-white text-gray-500 border-gray-200">ãƒ¬ãƒ™ãƒ«é †</button>
                    <button onclick="setPlayerSort('rest')" id="sort-rest" class="px-2 py-1 rounded border transition-colors bg-white text-gray-500 border-gray-200">çŠ¶æ…‹åˆ¥</button>
                </div>
            </div>

            <div id="player-list-area" class="space-y-2"></div>
            
            <div id="rank-summary-area" class="bg-gray-100 p-2 rounded-lg text-center shadow-inner text-xs font-bold flex justify-around"></div>

            <div class="pt-6 border-t space-y-4 text-center">
                <textarea id="csv-area" class="w-full h-24 text-[10px] p-2 border rounded bg-white mb-2 font-mono" placeholder="åç°¿ãƒ‡ãƒ¼ã‚¿"></textarea>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportAndCopy()" class="bg-white border border-indigo-300 text-indigo-700 py-2 rounded text-[10px] font-bold shadow-sm">åç°¿ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="openModal('å¾©å…ƒ', 'ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ', 'import')" class="bg-indigo-600 text-white py-2 rounded text-[10px] font-bold shadow-sm">åç°¿å¾©å…ƒ</button>
                </div>
                <button onclick="openModal('åˆæœŸåŒ–', 'å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ', 'reset')" class="w-full text-[10px] text-red-400 py-2 mt-4">ã‚¢ãƒ—ãƒªåˆæœŸåŒ–</button>
            </div>
        </section>

        <section id="tab-stats" class="hidden no-print">
            <div id="stat-list" class="bg-white p-4 rounded-xl shadow-sm border space-y-2 text-sm"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 text-[10px] text-gray-400 z-40 shadow-2xl no-print">
        <button onclick="showTab('matches')" id="btn-matches" class="active-tab flex flex-col items-center">è©¦åˆ</button>
        <button onclick="showTab('players')" id="btn-players" class="flex flex-col items-center">é¸æ‰‹</button>
        <button onclick="showTab('stats')" id="btn-stats" class="flex flex-col items-center">æˆç¸¾</button>
    </nav>

    <div id="custom-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg no-print">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 id="modal-title" class="font-bold text-lg mb-2">ç¢ºèª</h3>
            <p id="modal-message" class="text-sm text-gray-500 mb-6"></p>
            <div class="flex gap-2 justify-end">
                <button onclick="closeModal()" class="px-5 py-2.5 bg-gray-100 rounded-lg text-sm font-bold">æˆ»ã‚‹</button>
                <button id="modal-confirm-btn" class="px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-bold">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'badminton_final_balance_v99';
        
        // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåç°¿ï¼‰
        const defaultCSV = `åå‰,ãƒ©ãƒ³ã‚¯,æ€§åˆ¥,å‹æ•°
ãƒãƒŠ88,1,M,0
ãƒãƒ£ãƒ­,3,F,0
ã‚†ã£ã¡ã‚ƒã‚“,1,F,0
ã‚Šã‚Š,2,F,0
åœ°åº•äºº,2,M,0
ã‚‰ã‚€ã­,1,F,0
ããª,1,M,0
ã¡ã³ä¸¸,2,M,0
ãƒ’ãƒ­ã‚·ãƒ§ã‚¦,3,M,0
ãƒãƒªã‚¢,1,F,0
AYU,3,F,0
ã¾ãƒ¼,3,F,0
ã¯ã‚‹ã‹ã©ã‚“,2,F,0
ãªãŠã¨,1,M,0
san,2,M,0
ã„ã—ã—,2,M,0
ã¾ã•ã¨,2,M,0
ã‚ã,2,F,0
ã‚†ãƒ¼,3,F,0
ã®ã£ã¡,3,F,0
ã‘ã‚ã‚Šã‚“,2,M,0
ã‚ã‚Šã‚‚,3,F,0
ã‚¿ã‚«ãƒ¨ã‚·,3,M,0
ã‚³ãƒ¼,2,M,0
mono,1,M,0
ã²ã‚ƒã£ã‹,3,F,0
ãƒ¡ã‚¬ãƒã‚«ãƒ”ãƒãƒ©,1,M,0
ã‚ã‚„ãªã,3,F,0
ã—ã‚“ç¤¾é•·,2,M,0
ã€ãªãŠã¨ã€‘,1,M,0`;

        let players = JSON.parse(localStorage.getItem(STORAGE_KEY));

        // â˜… ãƒ‡ãƒ¼ã‚¿ãŒç©ºï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹ or åˆæœŸåŒ–ç›´å¾Œï¼‰ãªã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCSVã‚’èª­ã¿è¾¼ã‚“ã§åˆæœŸåŒ–ã™ã‚‹
        if (!players || players.length === 0) {
            players = [];
            const lines = defaultCSV.trim().split('\n');
            lines.forEach((line, i) => {
                if (i === 0 && line.includes("åå‰")) return;
                const c = line.split(',');
                if (c.length >= 3) players.push({ 
                    id: Date.now() + i, // idãŒã‹ã¶ã‚‰ã‚“ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¶³ã™
                    name: c[0].trim(), 
                    rank: parseInt(c[1])||2, 
                    gender: c[2].trim().toUpperCase()==='F'?'F':'M', 
                    wins: parseInt(c[3])||0, 
                    active: true, 
                    partners: [], 
                    gamesPlayed: 0, 
                    restStreak: 0, 
                    restMode: 0 
                });
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
        }
        
        players = players.map(p => {
            if (p.restMode === undefined) {
                return {...p, restMode: p.isResting ? 2 : 0};
            }
            return p;
        });

        let matches = [];
        let roundCount = parseInt(localStorage.getItem(STORAGE_KEY+'_round')) || 1;
        let currentTargetId = null;
        let currentMode = "";
        let currentModeName = "";
        let currentResting = [];
        let playerSortMode = 'default'; // â˜… ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
            localStorage.setItem(STORAGE_KEY+'_round', roundCount);
            renderAll();
        }

        function showTab(tabId) {
            ['matches', 'players', 'stats'].forEach(id => {
                document.getElementById('tab-'+id).classList.add('hidden');
                document.getElementById('btn-'+id).classList.remove('active-tab');
            });
            document.getElementById('tab-'+tabId).classList.remove('hidden');
            document.getElementById('btn-'+tabId).classList.add('active-tab');
            if(tabId === 'stats') renderStats();
        }

        function openModal(title, msg, mode, id = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = msg;
            currentMode = mode;
            currentTargetId = id;
            document.getElementById('custom-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }
        document.getElementById('modal-confirm-btn').onclick = function() {
            if (currentMode === "delete") players = players.filter(p => p.id !== currentTargetId);
            else if (currentMode === "import") executeImport();
            else if (currentMode === "reset") { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(STORAGE_KEY+'_round'); location.reload(); return; }
            save(); closeModal();
        };

        function addPlayer() {
            const name = document.getElementById('p-name').value.trim();
            if(!name) return;
            players.push({ id: Date.now(), name, gender: document.getElementById('p-gender').value, rank: parseInt(document.getElementById('p-rank').value), active: true, wins: 0, partners: [], gamesPlayed: 0, restStreak: 0, restMode: 0 });
            document.getElementById('p-name').value = '';
            save();
        }
        
        function toggleActive(id) { players = players.map(p => p.id === id ? {...p, active: !p.active} : p); save(); }
        
        function toggleRestMode(id) { 
            players = players.map(p => {
                if (p.id === id) {
                    return {...p, restMode: (p.restMode + 1) % 3};
                }
                return p;
            }); 
            save(); 
        }

        // â˜… æ–°æ©Ÿèƒ½ï¼šãƒ©ãƒ³ã‚¯ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹é–¢æ•°
        function updateRank(id, newRank) {
            players = players.map(p => p.id === id ? {...p, rank: parseInt(newRank)} : p);
            save();
        }

        // â˜… ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¦å†æç”»ã™ã‚‹é–¢æ•°
        function setPlayerSort(mode) {
            playerSortMode = mode;
            renderAll();
        }

        function renderAll() {
            const activeP = players.filter(p=>p.active);
            document.getElementById('header-count').innerText = "å‚åŠ : " + activeP.length + "å";
            
            // â˜… ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¨ã
            const csvArea = document.getElementById('csv-area');
            if (csvArea) {
                let currentCsv = "åå‰,ãƒ©ãƒ³ã‚¯,æ€§åˆ¥,å‹æ•°\n";
                players.forEach(p => { currentCsv += p.name + "," + p.rank + "," + p.gender + "," + p.wins + "\n"; });
                csvArea.value = currentCsv;
            }

            // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®UIçŠ¶æ…‹ï¼ˆè‰²ï¼‰ã‚’æ›´æ–°
            ['default', 'gender', 'rank', 'rest'].forEach(mode => {
                const btn = document.getElementById('sort-' + mode);
                if (btn) {
                    if (mode === playerSortMode) {
                        btn.className = "px-2 py-1 rounded border transition-colors bg-indigo-100 text-indigo-700 font-bold border-indigo-300";
                    } else {
                        btn.className = "px-2 py-1 rounded border transition-colors bg-white text-gray-500 border-gray-200";
                    }
                }
            });

            // â˜… è¡¨ç¤ºç”¨ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚½ãƒ¼ãƒˆ
            let displayPlayers = [...players];
            displayPlayers.sort((a, b) => {
                // 1. ã¾ãšã€Œä»Šæ—¥æ¥ã¦ãªã„ï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ã€äººã¯å•ç­”ç„¡ç”¨ã§ä¸‹ã«é…ç½®
                if (a.active !== b.active) return a.active ? -1 : 1;
                
                // 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ãŒåŒã˜ãªã‚‰ã€é¸ã°ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
                if (playerSortMode === 'gender') {
                    // ç”·å¥³åˆ¥ (ç”·æ€§MãŒå…ˆ) -> åŒæ€§ãªã‚‰ãƒ©ãƒ³ã‚¯é †
                    return b.gender.localeCompare(a.gender) || a.rank - b.rank;
                } else if (playerSortMode === 'rank') {
                    // ãƒ©ãƒ³ã‚¯é † (1 -> 2 -> 3) -> åŒãƒ©ãƒ³ã‚¯ãªã‚‰ç”·å¥³åˆ¥
                    return a.rank - b.rank || b.gender.localeCompare(a.gender);
                } else if (playerSortMode === 'rest') {
                    // çŠ¶æ…‹åˆ¥ (å‚åŠ ä¸­0 -> 1å›ä¼‘1 -> ä¼‘æ­¢ä¸­2) -> åŒçŠ¶æ…‹ãªã‚‰ãƒ©ãƒ³ã‚¯é †
                    return a.restMode - b.restMode || a.rank - b.rank;
                }
                
                // 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è¿½åŠ ã—ãŸé †ç•ªï¼ˆidé †ï¼‰
                return a.id - b.id;
            });

            // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®é…åˆ—ã‚’ä½¿ã£ã¦ç”»é¢ã«æç”»
            document.getElementById('player-list-area').innerHTML = displayPlayers.map(p => {
                let restBtnClass = 'bg-gray-50 border-gray-200 text-gray-400';
                let restBtnText = 'å‚åŠ ä¸­';
                if (p.restMode === 1) {
                    restBtnClass = 'bg-yellow-100 border-yellow-400 text-yellow-700 shadow-inner';
                    restBtnText = 'â˜•1å›ä¼‘';
                } else if (p.restMode === 2) {
                    restBtnClass = 'bg-orange-100 border-orange-400 text-orange-700 shadow-inner';
                    restBtnText = 'ğŸ’¤ä¼‘æ­¢ä¸­';
                }

                return `
                <div class="flex items-center justify-between p-3 rounded-lg border bg-white mb-2 shadow-sm ${p.gender==='M'?'border-blue-100':'border-pink-100'} ${p.active?'':'opacity-40'}">
                    <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleActive(${p.id})">
                        <div class="w-8 h-8 rounded-full ${p.gender==='M'?'bg-blue-400':'bg-pink-400'} flex items-center justify-center text-white text-[10px] font-bold">${p.name[0]}</div>
                        <span class="text-sm font-bold ${p.gender==='M'?'text-male':'text-female'}">${p.name} 
                            <select onchange="updateRank(${p.id}, this.value)" onclick="event.stopPropagation()" class="text-[10px] text-gray-500 bg-gray-50 border border-gray-200 rounded px-1 ml-1 font-normal focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="1" ${p.rank === 1 ? 'selected' : ''}>R1:å¼·</option>
                                <option value="2" ${p.rank === 2 ? 'selected' : ''}>R2:ä¸­</option>
                                <option value="3" ${p.rank === 3 ? 'selected' : ''}>R3:å¼±</option>
                            </select>
                        </span>
                    </div>
                    <div class="flex gap-2 items-center">
                        ${p.active ? `<button onclick="toggleRestMode(${p.id})" class="w-16 px-1 py-1 text-[10px] rounded border font-bold transition-all ${restBtnClass}">${restBtnText}</button>` : ''}
                        <button onclick="openModal('å‰Šé™¤', '${p.name}ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ', 'delete', ${p.id})" class="text-gray-300 px-2 text-lg">âœ•</button>
                    </div>
                </div>`
            }).join('');

            const r1 = activeP.filter(p => p.rank === 1).length;
            const r2 = activeP.filter(p => p.rank === 2).length;
            const r3 = activeP.filter(p => p.rank === 3).length;
            document.getElementById('rank-summary-area').innerHTML = `
                <span class="text-indigo-600">R1(å¼·): ${r1}å</span>
                <span class="text-green-600">R2(ä¸­): ${r2}å</span>
                <span class="text-orange-600">R3(å¼±): ${r3}å</span>
            `;
        }

        function generateMatches(mode) {
            const active = players.filter(p => p.active);
            if(active.length < 4) return alert('4äººä»¥ä¸Šå¿…è¦ã§ã™');

            const available = active.filter(p => p.restMode === 0);
            const manualResting = active.filter(p => p.restMode > 0);

            if (available.length < 4) return alert('è©¦åˆå¯èƒ½ãªãƒ¡ãƒ³ãƒãƒ¼ãŒ4äººæœªæº€ã‚„ï¼ä¼‘æ†©ä¸­ã®äººãŒå¤šã™ãã‚‹ã§ã€‚');

            const sorted = [...available].sort((a,b) => (a.gamesPlayed - b.gamesPlayed) || (b.restStreak - a.restStreak) || (Math.random() - 0.5));
            const numCourts = Math.floor(available.length / 4);
            let inGame = sorted.slice(0, numCourts * 4);
            
            const autoResting = sorted.slice(numCourts * 4);
            const resting = [...manualResting, ...autoResting];
            currentResting = resting;

            if (mode === 'level') {
                inGame.sort((a,b) => a.rank - b.rank);
            } else {
                inGame.sort(() => Math.random() - 0.5);
            }
            
            matches = [];
            let pool = [...inGame];

            for(let i=0; i<numCourts; i++) {
                let courtPlayers = pool.splice(0, 4);

                if (mode === 'random') {
                    courtPlayers.sort(() => Math.random() - 0.5);
                    matches.push({ court: i+1, pairA: [courtPlayers[0], courtPlayers[1]], pairB: [courtPlayers[2], courtPlayers[3]], winner: null, isDone: false });
                } else {
                    const best = getBestSplit(courtPlayers, mode);
                    matches.push({ court: i+1, pairA: best.pairA, pairB: best.pairB, winner: null, isDone: false });
                }
            }

            players = players.map(p => {
                let newRestMode = p.restMode;
                if (p.restMode === 1) {
                    newRestMode = 0;
                }

                const playing = inGame.find(x => x.id === p.id);
                if(playing) {
                    const m = matches.find(m => m.pairA.find(x=>x.id===p.id) || m.pairB.find(x=>x.id===p.id));
                    const pair = m.pairA.find(x=>x.id===p.id) ? m.pairA : m.pairB;
                    const partner = pair[0].id === p.id ? pair[1].id : pair[0].id;
                    return {...p, gamesPlayed: p.gamesPlayed + 1, restStreak: 0, partners: [...p.partners, partner], restMode: newRestMode};
                }
                return {...p, restStreak: p.active ? p.restStreak + 1 : 0, restMode: newRestMode};
            });

            currentModeName = mode==='level' ? 'ãƒ¬ãƒ™ãƒ«åˆ¥' : (mode==='balanced'?'ãƒãƒ©ãƒ³ã‚¹':'ãƒ©ãƒ³ãƒ€ãƒ ');
            roundCount++;
            save();
            renderMatches(resting);
        }

        function getBestSplit(p, mode) {
            const combs = [{ a: [p[0], p[1]], b: [p[2], p[3]] }, { a: [p[0], p[2]], b: [p[1], p[3]] }, { a: [p[0], p[3]], b: [p[1], p[2]] }];
            let best = combs[0]; let minS = Infinity;
            
            combs.forEach(c => {
                let s = 0;
                const rA1 = c.a[0].rank; const rA2 = c.a[1].rank; const rB1 = c.b[0].rank; const rB2 = c.b[1].rank;
                
                if (mode === 'level') { 
                    s += Math.abs(rA1 - rA2) * 500 + Math.abs(rB1 - rB2) * 500; 
                } else if (mode === 'balanced') { 
                    s += Math.abs((rA1+rA2) - (rB1+rB2)) * 5000; 
                }
                
                if (c.a[0].partners.includes(c.a[1].id)) s += 20000;
                if (c.b[0].partners.includes(c.b[1].id)) s += 20000;
                
                s += Math.random(); 
                if (s < minS) { minS = s; best = c; }
            });
            return { pairA: best.a, pairB: best.b };
        }

        function recordWin(mIdx, side) {
            if(matches[mIdx].winner) return;
            matches[mIdx].winner = side;
            matches[mIdx].isDone = true;
            (side === 'A' ? matches[mIdx].pairA : matches[mIdx].pairB).forEach(w => { 
                const p = players.find(x => x.id === w.id); if(p) p.wins++; 
            });
            save(); renderMatches(currentResting);
        }

        function toggleMatchDone(mIdx) {
            matches[mIdx].isDone = !matches[mIdx].isDone;
            renderMatches(currentResting);
        }

        function moveMatch(index, direction) {
            if (index + direction < 0 || index + direction >= matches.length) return;
            
            const temp = matches[index];
            matches[index] = matches[index + direction];
            matches[index + direction] = temp;
            
            matches.forEach((m, i) => { m.court = i + 1; });
            
            save(); 
            renderMatches(currentResting);
        }

        function renderMatches(resting) {
            const area = document.getElementById('match-display-area');
            const btn = document.getElementById('btn-print');
            if(matches.length > 0) {
                btn.classList.remove('hidden');
                area.innerHTML = matches.map((m, idx) => `
                <div class="match-card p-4 rounded-xl border shadow-md relative overflow-hidden transition-all ${m.isDone ? 'bg-gray-100 opacity-60 border-gray-300' : 'bg-white'}">
                    
                    <div class="print-court-label">ç¬¬${m.court}ã‚³ãƒ¼ãƒˆ</div>

                    <div class="court-label-area absolute top-0 left-0 flex shadow-sm z-10">
                        <div class="${m.isDone ? 'bg-gray-400' : 'bg-gray-800'} text-white text-[10px] px-3 py-1 font-bold flex items-center">ç¬¬${m.court}ã‚³ãƒ¼ãƒˆ</div>
                        <div class="flex bg-gray-100 border-b border-r border-gray-300 rounded-br-lg overflow-hidden">
                            <button onclick="moveMatch(${idx}, -1)" class="px-2 py-0.5 text-[10px] text-gray-600 hover:bg-gray-300 active:bg-gray-400 disabled:opacity-20 transition-colors border-r border-gray-300" ${idx === 0 ? 'disabled' : ''}>â–²</button>
                            <button onclick="moveMatch(${idx}, 1)" class="px-2 py-0.5 text-[10px] text-gray-600 hover:bg-gray-300 active:bg-gray-400 disabled:opacity-20 transition-colors" ${idx === matches.length - 1 ? 'disabled' : ''}>â–¼</button>
                        </div>
                    </div>
                    
                    <button onclick="toggleMatchDone(${idx})" class="absolute top-2 right-2 text-[10px] font-bold border rounded px-2 py-1 transition-all flex items-center gap-1 z-10 ${m.isDone ? 'bg-green-500 text-white border-green-500 shadow-inner' : 'bg-white text-gray-400 border-gray-200 hover:bg-gray-50'}">
                        ${m.isDone ? 'â˜‘ çµ‚äº†' : 'â˜ é€²è¡Œä¸­'}
                    </button>

                    <div class="flex justify-between items-center gap-2 mt-4 text-center relative z-0">
                        <div class="team-box flex-1 p-2 ${m.winner==='A'?'bg-yellow-50 ring-2 ring-yellow-400':'bg-gray-50'} rounded text-xs font-bold border">
                            <span class="${m.pairA[0].gender==='M'?'text-male':'text-female'}">${m.pairA[0].name}</span><br>
                            <span class="${m.pairA[1].gender==='M'?'text-male':'text-female'}">${m.pairA[1].name}</span>
                            ${!m.winner?`<button onclick="recordWin(${idx},'A')" class="mt-2 w-full bg-white border py-1 rounded text-[9px] text-gray-600 hover:bg-yellow-50">WIN</button>`:''}
                        </div>
                        <div class="vs-label text-[10px] text-gray-400 font-bold italic">VS</div>
                        <div class="team-box flex-1 p-2 ${m.winner==='B'?'bg-yellow-50 ring-2 ring-yellow-400':'bg-gray-50'} rounded text-xs font-bold border">
                            <span class="${m.pairB[0].gender==='M'?'text-male':'text-female'}">${m.pairB[0].name}</span><br>
                            <span class="${m.pairB[1].gender==='M'?'text-male':'text-female'}">${m.pairB[1].name}</span>
                            ${!m.winner?`<button onclick="recordWin(${idx},'B')" class="mt-2 w-full bg-white border py-1 rounded text-[9px] text-gray-600 hover:bg-yellow-50">WIN</button>`:''}
                        </div>
                    </div>
                </div>`).join('');
            } else btn.classList.add('hidden');

            const restSec = document.getElementById('rest-section');
            if(resting && resting.length > 0) {
                restSec.classList.remove('hidden');
                document.getElementById('rest-list-area').innerHTML = resting.map(p => {
                    let badgeClass = 'bg-gray-200';
                    let icon = '';
                    if (p.restMode === 1) { badgeClass = 'bg-yellow-100 border-yellow-300'; icon = '<span class="text-[8px]">â˜•1å›ä¼‘</span>'; }
                    if (p.restMode === 2) { badgeClass = 'bg-orange-100 border-orange-300'; icon = '<span class="text-[8px]">ğŸ’¤ä¼‘æ­¢</span>'; }
                    
                    return `<span class="text-[10px] ${badgeClass} px-2 py-1 rounded border ${p.gender==='M'?'text-male':'text-female'} font-bold flex items-center gap-1">${p.name}${icon}</span>`
                }).join('');
            } else restSec.classList.add('hidden');
        }

        function openPrintWindow() {
            const playingIds = new Set();
            matches.forEach(m => {
                m.pairA.forEach(p => playingIds.add(p.id));
                m.pairB.forEach(p => playingIds.add(p.id));
            });
            const restingPlayers = players.filter(p => p.active && !playingIds.has(p.id));

            let matchHtml = matches.map(m => `
                <div class="match-box">
                    <div class="court-title">ç¬¬${m.court}ã‚³ãƒ¼ãƒˆ</div>
                    <div class="teams">
                        <div class="team">
                            <div class="${m.pairA[0].gender==='M'?'male':'female'}">${m.pairA[0].name}</div>
                            <div class="${m.pairA[1].gender==='M'?'male':'female'}">${m.pairA[1].name}</div>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <div class="${m.pairB[0].gender==='M'?'male':'female'}">${m.pairB[0].name}</div>
                            <div class="${m.pairB[1].gender==='M'?'male':'female'}">${m.pairB[1].name}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            let restHtml = "";
            if(restingPlayers.length > 0) {
                const names = restingPlayers.map(p => {
                    let label = '';
                    if(p.restMode === 1) label = '(1å›ä¼‘)';
                    if(p.restMode === 2) label = '(ä¼‘æ­¢)';
                    return `<span class="${p.gender==='M'?'male':'female'}">${p.name}${label}</span>`
                }).join(' / ');

                restHtml = `
                    <div class="rest-box">
                        <div class="rest-title">ä»Šå›ã®ãŠä¼‘ã¿</div>
                        <div class="rest-names">${names}</div>
                    </div>
                `;
            }

            const win = window.open('', '_blank');
            if(!win) return alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãªã€‚");

            win.document.write(`
                <html>
                <head>
                    <title>å¯¾æˆ¦è¡¨å°åˆ·</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        h1 { text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                        .match-box { border: 1px solid #000; padding: 10px; break-inside: avoid; text-align: center; }
                        .court-title { background: #333; color: #fff; display: inline-block; padding: 3px 10px; font-size: 12px; margin-bottom: 10px; border-radius: 4px; }
                        .teams { display: flex; justify-content: center; align-items: center; gap: 10px; }
                        .team { border: 1px solid #ccc; padding: 10px; width: 40%; font-weight: bold; font-size: 14px; }
                        .vs { font-style: italic; color: #666; font-weight: bold; }
                        .male { color: #1d4ed8; }
                        .female { color: #db2777; }
                        .rest-box { margin-top: 30px; border: 2px dashed #999; padding: 15px; text-align: center; break-inside: avoid; }
                        .rest-title { font-weight: bold; margin-bottom: 10px; background: #eee; display: inline-block; padding: 2px 10px; border-radius: 4px; }
                        .rest-names { font-weight: bold; font-size: 14px; }
                        @media print { body { -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <h1>ç¬¬${roundCount-1}è©¦åˆ (${currentModeName})</h1>
                    <div class="grid">${matchHtml}</div>
                    ${restHtml}
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            win.document.close();
        }

        function exportAndCopy() {
            let csv = "åå‰,ãƒ©ãƒ³ã‚¯,æ€§åˆ¥,å‹æ•°\n";
            players.forEach(p => { csv += p.name + "," + p.rank + "," + p.gender + "," + p.wins + "\n"; });
            const area = document.getElementById('csv-area');
            area.value = csv; area.select(); document.execCommand('copy');
            alert("ã‚³ãƒ”ãƒ¼ã—ãŸã§ï¼ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã§ã‚‚è²¼ã‚Šä»˜ã‘ã‚„ï¼");
        }
        function executeImport() {
            const lines = document.getElementById('csv-area').value.trim().split('\n');
            const newList = [];
            lines.forEach((line, i) => {
                if (i === 0 && line.includes("åå‰")) return;
                const c = line.split(',');
                if (c.length >= 3) newList.push({ id: Date.now()+Math.random(), name: c[0].trim(), rank: parseInt(c[1])||2, gender: c[2].trim().toUpperCase()==='F'?'F':'M', wins: parseInt(c[3])||0, active: true, partners: [], gamesPlayed: 0, restStreak: 0, restMode: 0 });
            });
            if(newList.length > 0) { players = newList; alert("åç°¿ã‚’å¾©å…ƒã—ãŸã§ï¼"); }
            else { alert("ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã‚“ã‹ã£ãŸã‚ã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªã—ã¦ãªã€‚"); }
        }
        function renderStats() {
            const sorted = [...players].sort((a,b) => b.wins - a.wins);
            document.getElementById('stat-list').innerHTML = sorted.map((p,i) => `<div class="flex justify-between border-b py-2"><span>${i+1}. <span class="${p.gender==='M'?'text-male':'text-female'} font-bold">${p.name}</span></span><span class="font-bold text-indigo-600">${p.wins}å‹</span></div>`).join('') || 'ãªã—';
        }

        renderAll();
    </script>
</body>
</html>
